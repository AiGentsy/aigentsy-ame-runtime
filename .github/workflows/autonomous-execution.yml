# ═══════════════════════════════════════════════════════════════════════════════
# AiGentsy Autonomous Execution Workflow v5 - RESILIENT
# Updated: January 3, 2026
# Based on v4 (77-file audit) + resilient error handling
# ═══════════════════════════════════════════════════════════════════════════════
#
# CHANGES FROM v4:
# - All steps use continue-on-error: true (won't fail workflow)
# - Better JSON parsing with fallbacks
# - Single job structure (more reliable than parallel jobs)
# - Always returns success even if endpoints are down
# - Cleaner error messages
#
# SYSTEMS ORCHESTRATED (143+ subsystems across 77 files):
# - Discovery: 27+ platforms, signal ingestion, opportunity filters
# - Routing: C-Suite orchestrator, scoring, approval workflows  
# - Outreach: Auto-bidding, AME pitches, social posting
# - Fulfillment: Graphics, video, audio, code generation
# - Payment: Escrow, revenue flows, batch payments
# - Learning: Yield memory, MetaHive, deal graph
# - Protocol: AIGx, SLO tiers, arbitrage pipeline
#
# ═══════════════════════════════════════════════════════════════════════════════

name: AiGentsy Autonomous Execution v5

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - discovery_only
          - social_only
          - health_only
          - ame_pitches
          - arbitrage_only
      auto_approve_user:
        description: 'Auto-approve user opportunities (>60% win prob)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      max_executions:
        description: 'Max opportunities to execute per run'
        required: false
        default: '10'

env:
  BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://aigentsy-ame-runtime.onrender.com' }}

jobs:
  # ═══════════════════════════════════════════════════════════════════════════════
  # SINGLE RESILIENT JOB - All steps continue on error
  # ═══════════════════════════════════════════════════════════════════════════════
  autonomous:
    name: 🤖 Autonomous Execution
    runs-on: ubuntu-latest
    
    steps:
      # ─────────────────────────────────────────────────────────────────────────
      # STEP 1: Health Check
      # ─────────────────────────────────────────────────────────────────────────
      - name: 🏥 Health Check
        id: health
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏥 SYSTEM HEALTH CHECK"
          echo "   Backend: ${{ env.BACKEND_URL }}"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          
          # Simple health check first
          RESPONSE=$(curl -s --max-time 30 "${{ env.BACKEND_URL }}/health" 2>&1 || echo '{"status": "unreachable"}')
          
          # Check if response is valid JSON
          if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
            echo "✅ Backend Status: $STATUS"
          else
            echo "⚠️ Backend returned non-JSON response (may be starting up)"
            echo "   Response preview: ${RESPONSE:0:100}"
          fi
          
          # Try detailed health
          DETAIL=$(curl -s --max-time 30 "${{ env.BACKEND_URL }}/execution/health/detail" 2>&1 || echo '{}')
          if echo "$DETAIL" | jq -e '.ok' >/dev/null 2>&1; then
            WORKING=$(echo "$DETAIL" | jq -r '.working // 0')
            echo "   Working systems: $WORKING"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 2: Discovery & Execution
      # ─────────────────────────────────────────────────────────────────────────
      - name: 🔍 Discovery & Execution
        id: discovery
        continue-on-error: true
        if: ${{ github.event.inputs.mode != 'social_only' && github.event.inputs.mode != 'health_only' }}
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔍 AUTONOMOUS DISCOVERY ENGINE"
          echo "   Scanning 27+ platforms for opportunities"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "⚙️  Configuration:"
          echo "   Auto-approve: ${{ github.event.inputs.auto_approve_user || 'true' }}"
          echo "   Max executions: ${{ github.event.inputs.max_executions || '10' }}"
          echo ""
          
          # Build request
          REQUEST='{"auto_approve_user": ${{ github.event.inputs.auto_approve_user || true }}, "max_executions": ${{ github.event.inputs.max_executions || 10 }}}'
          
          # Try discover-and-execute
          echo "📡 Calling /autonomous/discover-and-execute..."
          RESPONSE=$(curl -s -X POST "${{ env.BACKEND_URL }}/autonomous/discover-and-execute" \
            -H "Content-Type: application/json" \
            -d "$REQUEST" \
            --max-time 180 2>&1 || echo '{"ok": false, "error": "request_failed"}')
          
          # Check if valid JSON
          if ! echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            echo "⚠️ Non-JSON response, trying fallback..."
            RESPONSE=$(curl -s -X POST "${{ env.BACKEND_URL }}/autonomous/full-cycle" \
              -H "Content-Type: application/json" \
              --max-time 180 2>&1 || echo '{"ok": false}')
          fi
          
          # Parse response
          if echo "$RESPONSE" | jq -e '.ok == true' >/dev/null 2>&1; then
            DISCOVERED=$(echo "$RESPONSE" | jq -r '.discovery.total_opportunities // 0')
            EXECUTED=$(echo "$RESPONSE" | jq -r '.executions.count // 0')
            VALUE=$(echo "$RESPONSE" | jq -r '.discovery.total_value // 0')
            MESSAGE=$(echo "$RESPONSE" | jq -r '.message // "Complete"')
            
            echo ""
            echo "✅ DISCOVERY COMPLETE"
            echo "   Opportunities Found: $DISCOVERED"
            echo "   Total Value: \$$VALUE"
            echo "   Executed: $EXECUTED"
            echo "   Message: $MESSAGE"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"' 2>/dev/null || echo "Parse error")
            echo "⚠️ Discovery returned: $ERROR"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 3: AME Pitch Processing
      # ─────────────────────────────────────────────────────────────────────────
      - name: 📧 AME Pitches
        continue-on-error: true
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'ame_pitches' }}
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📧 AME PITCH PROCESSING"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          
          RESPONSE=$(curl -s -X POST "${{ env.BACKEND_URL }}/ame/process-queue" \
            -H "Content-Type: application/json" \
            --max-time 60 2>&1 || echo '{"ok": false}')
          
          if echo "$RESPONSE" | jq -e '.ok == true' >/dev/null 2>&1; then
            PROCESSED=$(echo "$RESPONSE" | jq -r '.processed // 0')
            SENT=$(echo "$RESPONSE" | jq -r '.sent // 0')
            echo "✅ AME Results:"
            echo "   Processed: $PROCESSED"
            echo "   Sent: $SENT"
          else
            echo "⚠️ AME queue empty or unavailable"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 4: Social Posting
      # ─────────────────────────────────────────────────────────────────────────
      - name: 📱 Social Posting
        continue-on-error: true
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'social_only' }}
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📱 SOCIAL AUTO-POSTING"
          echo "   Platforms: TikTok, Instagram, YouTube, Twitter, LinkedIn"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          
          RESPONSE=$(curl -s -X POST "${{ env.BACKEND_URL }}/social/process-queue" \
            -H "Content-Type: application/json" \
            --max-time 60 2>&1 || echo '{"ok": false}')
          
          if echo "$RESPONSE" | jq -e '.ok == true' >/dev/null 2>&1; then
            PROCESSED=$(echo "$RESPONSE" | jq -r '.processed // 0')
            echo "✅ Social posts processed: $PROCESSED"
          else
            echo "⚠️ Social queue empty or unavailable"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 5: Arbitrage Execution
      # ─────────────────────────────────────────────────────────────────────────
      - name: 💵 Arbitrage
        continue-on-error: true
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'arbitrage_only' }}
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💵 ARBITRAGE EXECUTION"
          echo "   Detect → Purchase → Fulfill → List → Settle"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          
          RESPONSE=$(curl -s -X POST "${{ env.BACKEND_URL }}/arbitrage/execute" \
            -H "Content-Type: application/json" \
            -d '{"max_opportunities": 5}' \
            --max-time 120 2>&1 || echo '{"ok": false}')
          
          if echo "$RESPONSE" | jq -e '.ok == true' >/dev/null 2>&1; then
            PROFIT=$(echo "$RESPONSE" | jq -r '.total_profit // 0')
            COMPLETED=$(echo "$RESPONSE" | jq -r '.completed // 0')
            echo "✅ Arbitrage Results:"
            echo "   Completed: $COMPLETED"
            echo "   Profit: \$$PROFIT"
          else
            echo "⚠️ Arbitrage unavailable or no opportunities"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 6: Statistics
      # ─────────────────────────────────────────────────────────────────────────
      - name: 📊 Statistics
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📊 SYSTEM STATISTICS"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          
          # Autonomous stats
          STATS=$(curl -s --max-time 15 "${{ env.BACKEND_URL }}/autonomous/stats" 2>&1 || echo '{}')
          if echo "$STATS" | jq -e '.ok' >/dev/null 2>&1; then
            PENDING=$(echo "$STATS" | jq -r '.pending_count // 0')
            echo "🤖 Autonomous Queue:"
            echo "   Pending approvals: $PENDING"
          fi
          
          # Execution stats
          EXEC=$(curl -s --max-time 15 "${{ env.BACKEND_URL }}/execution/stats" 2>&1 || echo '{}')
          if echo "$EXEC" | jq -e '.ok' >/dev/null 2>&1; then
            COMPLETED=$(echo "$EXEC" | jq -r '.completed // 0')
            echo "⚡ Executions:"
            echo "   Completed: $COMPLETED"
          fi
          
          # APEX dashboard
          APEX=$(curl -s --max-time 15 "${{ env.BACKEND_URL }}/apex/upgrades/dashboard" 2>&1 || echo '{}')
          if echo "$APEX" | jq -e '.ok' >/dev/null 2>&1; then
            REVENUE=$(echo "$APEX" | jq -r '.systems.reconciliation.total_revenue // 0')
            echo "💵 Revenue Tracked: \$$REVENUE"
          fi
          echo ""

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 7: Summary (Always runs)
      # ─────────────────────────────────────────────────────────────────────────
      - name: 📝 Run Summary
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "📝 AIGENTSY AUTONOMOUS RUN SUMMARY v5"
          echo "   77 files | 143+ systems | ~95,000 lines"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "🕐 Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "🔧 Mode: ${{ github.event.inputs.mode || 'full' }}"
          echo "🔗 Backend: ${{ env.BACKEND_URL }}"
          echo ""
          echo "📋 STEP RESULTS:"
          echo "   Health Check: ${{ steps.health.outcome || 'skipped' }}"
          echo "   Discovery: ${{ steps.discovery.outcome || 'skipped' }}"
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "              ✅ AIGENTSY v5 RUN COMPLETE"
          echo "═══════════════════════════════════════════════════════════════"
