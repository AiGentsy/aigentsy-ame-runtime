# ═══════════════════════════════════════════════════════════════════════════════
# AiGentsy v99 – AUTONOMOUS CLOSING PIPELINE
# The Ultimate Autonomous Money Machine + Financial Discipline + AUTO-CLOSING
# January 14, 2026
# ═══════════════════════════════════════════════════════════════════════════════
#
# FUSES:
# • v98: PROFIT ENGINE - ROI Gates, Ownership, Backpressure, Pricing Bandit
# • v97: APEX DOMINATOR (Adaptive Aggression, Swarm, Kelly, Waves)
# • v96: Cash-Verified, Profit-First, Self-Healing, SLO Policy
# • v94: Internet Domination (27+ platforms, Demand Vacuum, Viral Machine)
# • v93: Apex Upgrades (12 revenue optimization modules)
# • NEW v99: AUTONOMOUS CLOSING - Reply Detection, Platform Engagement, 
#            Conversation AI, Contract + Deposit Automation
#
# ═══════════════════════════════════════════════════════════════════════════════
# NEW IN v99 - AUTONOMOUS CLOSING PIPELINE:
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ 📬 REPLY DETECTION ENGINE                                                   │
# │   • Resend webhook integration (delivered, opened, clicked)                │
# │   • Twitter DM inbox polling + Reddit inbox polling                        │
# │   • Intent detection (interested, question, objection, ready_to_buy)       │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 💬 PLATFORM ENGAGEMENT ENGINE                                               │
# │   • Post helpful comments on Reddit, Twitter, GitHub, LinkedIn             │
# │   • Warm-up engagement BEFORE sending DMs (5-15 min delay)                 │
# │   • Real OAuth 1.0a for Twitter, OAuth for Reddit/LinkedIn                 │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 🗣️ CONVERSATION AI ENGINE                                                   │
# │   • Multi-turn dialogue management                                         │
# │   • Qualification extraction (budget, timeline, decision maker)            │
# │   • Objection handling + AI response generation via OpenRouter             │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 📝 CONTRACT + DEPOSIT AUTOMATION                                            │
# │   • Auto-generate service agreements (HTML + text)                         │
# │   • Stripe Payment Links for deposits (50% default)                        │
# │   • Auto-mark deal as CLOSED_WON when paid                                 │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# ═══════════════════════════════════════════════════════════════════════════════
# v97 FEATURES (unchanged):
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ 🧠 ADAPTIVE AGGRESSION ENGINE                                               │
# │   • Dynamically adjusts execution intensity based on cash flow             │
# │   • Low cash = BEAST MODE (aggressive bidding, fast SKUs, burst marketing) │
# │   • High cash = OPTIMIZE MODE (margin focus, quality over quantity)        │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 💱 MULTI-CURRENCY ARBITRAGE                                                 │
# │   • Exploit FX spreads + regional pricing simultaneously                   │
# │   • Auto-convert earnings to strongest currency                            │
# │   • Geo-aware pricing (charge USD in US, EUR in EU, etc.)                  │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 🐝 AI SWARM INTELLIGENCE                                                    │
# │   • Multiple AI workers (Claude, GPT, Perplexity) compete for best output  │
# │   • Winner-take-all: best response gets deployed                           │
# │   • Cross-learning: losers learn from winners via MetaHive                 │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ ⚡ REAL-TIME OPPORTUNITY SNIPER                                             │
# │   • WebSocket connections to freelance platforms                           │
# │   • Bid within 60 seconds of job posting                                   │
# │   • First-mover advantage = 3x win rate                                    │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 🎰 PORTFOLIO KELLY CRITERION                                                │
# │   • Optimal bet sizing based on win probability                            │
# │   • Never over-allocate to low-probability opportunities                   │
# │   • Mathematically maximize long-term growth                               │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 🔄 PERPETUAL MOTION REVENUE                                                 │
# │   • Every completed deal triggers 3 more actions:                          │
# │     1. Upsell/cross-sell to client                                         │
# │     2. Request referral                                                    │
# │     3. Generate case study → content → leads                               │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 🌊 DEMAND WAVE RIDING                                                       │
# │   • Predict demand spikes 24-72h ahead using signals                       │
# │   • Pre-position capacity and content before wave hits                     │
# │   • Ride the wave with premium pricing                                     │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# EXECUTION FREQUENCY: Adaptive (5min when SLO violated, 15min normal, 60min optimized)
# TOTAL ENDPOINTS: 320+
# PHASES: 36
#
# ═══════════════════════════════════════════════════════════════════════════════

name: AiGentsy v99 AUTONOMOUS CLOSING PIPELINE

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 min baseline (adaptive override possible)
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: false
        default: 'domination'
        type: choice
        options: [domination, full, beast, optimize, discovery, financial, marketing, health, closing]
      aggression:
        description: 'Aggression level (1-10, 0=auto)'
        required: false
        default: '0'
        type: string

concurrency:
  group: aigentsy-v99-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://aigentsy-ame-runtime.onrender.com' }}
  AGGRESSION_INPUT: ${{ github.event.inputs.aggression || '0' }}

jobs:
  apex-dominator:
    name: "🏦 v99 AUTONOMOUS CLOSING (320+ endpoints)"
    runs-on: ubuntu-latest
    timeout-minutes: 55

    steps:
      # ═══════════════════════════════════════════════════════════════════════
      # SETUP + TOOLING
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🧰 Setup Environment
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq bc moreutils
          mkdir -p json metrics logs
          echo "🏆 APEX DOMINATOR v97 ACTIVATED"
          echo "🕐 $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: 🔧 Define Execution Helpers
        run: |
          # Retry helper with exponential backoff
          cat > _curl.sh <<'BASH'
          #!/usr/bin/env bash
          URL="$1"; METHOD="${2:-GET}"; DATA="${3:-}"; TIMEOUT="${4:-120}"
          for i in 1 2 3; do
            if [ "$METHOD" = "GET" ]; then
              R=$(curl -sS "$URL" --max-time "$TIMEOUT" -H "Content-Type: application/json" 2>/dev/null) && echo "$R" && exit 0
            else
              R=$(curl -sS -X "$METHOD" "$URL" --max-time "$TIMEOUT" -H "Content-Type: application/json" -d "${DATA:-{}}" 2>/dev/null) && echo "$R" && exit 0
            fi
            sleep $((i * 2))
          done
          echo '{"ok":false,"error":"timeout"}'
          BASH
          chmod +x _curl.sh
          
          # Parallel executor
          cat > _parallel.sh <<'BASH'
          #!/usr/bin/env bash
          BACKEND="$1"; shift
          for ep in "$@"; do
            (curl -sS -X POST "${BACKEND}${ep}" -H "Content-Type: application/json" -d '{}' --max-time 60 2>/dev/null | jq -c '{ok}' || echo '{"ok":false}') &
          done
          wait
          BASH
          chmod +x _parallel.sh

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 0: CASH HEARTBEAT - Now with safe error handling
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💓 Cash Heartbeat (Stripe-Ledger Verified)
        id: cash
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💓 CASH HEARTBEAT - STRIPE-VERIFIED TRUTH"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Initialize defaults
          VERIFIED="0"
          SCHEDULED="0"
          PIPELINE="0"
          MRR="0"
          
          # Get verified cash (last 6h) - with safe parsing
          CASH_JSON=$(./_curl.sh "${{ env.BACKEND_URL }}/revenue/cash-ledger/summary?hours=6" GET '' 30 2>/dev/null || echo '{}')
          if echo "$CASH_JSON" | jq -e '.verified_cash' >/dev/null 2>&1; then
            VERIFIED=$(echo "$CASH_JSON" | jq -r '.verified_cash // 0')
          fi
          echo "verified_6h=$VERIFIED" >> $GITHUB_OUTPUT
          
          # Get scheduled payouts (next 24h)
          SCHED_JSON=$(./_curl.sh "${{ env.BACKEND_URL }}/finance/stripe/payouts/scheduled?hours=24" GET '' 30 2>/dev/null || echo '{}')
          if echo "$SCHED_JSON" | jq -e '.scheduled_total' >/dev/null 2>&1; then
            SCHEDULED=$(echo "$SCHED_JSON" | jq -r '.scheduled_total // 0')
          fi
          echo "scheduled_24h=$SCHEDULED" >> $GITHUB_OUTPUT
          
          # Get pipeline value
          PIPE_JSON=$(./_curl.sh "${{ env.BACKEND_URL }}/deals/pipeline-value" GET '' 30 2>/dev/null || echo '{}')
          if echo "$PIPE_JSON" | jq -e '.total_value' >/dev/null 2>&1; then
            PIPELINE=$(echo "$PIPE_JSON" | jq -r '.total_value // 0')
          fi
          echo "pipeline=$PIPELINE" >> $GITHUB_OUTPUT
          
          # Get MRR
          MRR_JSON=$(./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/subscriptions/mrr" GET '' 30 2>/dev/null || echo '{}')
          if echo "$MRR_JSON" | jq -e '.mrr' >/dev/null 2>&1; then
            MRR=$(echo "$MRR_JSON" | jq -r '.mrr // 0')
          fi
          echo "mrr=$MRR" >> $GITHUB_OUTPUT
          
          echo "💰 Verified (6h): $VERIFIED | Scheduled (24h): $SCHEDULED | Pipeline: $PIPELINE | MRR: $MRR"

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 1: ADAPTIVE AGGRESSION ENGINE (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🧠 Adaptive Aggression Engine
        id: aggression
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🧠 ADAPTIVE AGGRESSION ENGINE"
          echo "═══════════════════════════════════════════════════════════════"
          
          VERIFIED="${{ steps.cash.outputs.verified_6h }}"
          VERIFIED="${VERIFIED:-0}"
          INPUT_AGG="${{ env.AGGRESSION_INPUT }}"
          INPUT_AGG="${INPUT_AGG:-0}"
          
          # Auto-calculate aggression if not manually set
          if [ "$INPUT_AGG" = "0" ]; then
            # Safe comparison - treat empty/null as 0 (BEAST MODE)
            if [ -z "$VERIFIED" ] || [ "$VERIFIED" = "0" ] || [ "$VERIFIED" = "null" ]; then
              AGG=10
              MODE="BEAST"
            elif [ "$(echo "$VERIFIED < 500" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
              AGG=8
              MODE="HIGH"
            elif [ "$(echo "$VERIFIED < 2000" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
              AGG=6
              MODE="NORMAL"
            else
              AGG=4
              MODE="OPTIMIZE"
            fi
          else
            AGG=$INPUT_AGG
            MODE="MANUAL"
          fi
          
          echo "aggression=$AGG" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          
          echo "⚡ Aggression: $AGG/10 | Mode: $MODE"
          
          # Apply aggression settings to backend
          ./_curl.sh "${{ env.BACKEND_URL }}/orchestrator/set-aggression" POST "{\"level\":$AGG,\"mode\":\"$MODE\"}" 30 2>/dev/null | jq -c '{ok}' || echo '{"ok":"sent"}'

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 2: SLO POLICY + AUTO-REMEDIATION
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🔥 SLO Policy (Revenue Protection)
        id: slo
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔥 SLO POLICY - REVENUE PROTECTION"
          echo "═══════════════════════════════════════════════════════════════"
          
          VERIFIED="${{ steps.cash.outputs.verified_6h }}"
          VERIFIED="${VERIFIED:-0}"
          
          # Safe comparison - trigger SLO if empty, null, or zero
          if [ -z "$VERIFIED" ] || [ "$VERIFIED" = "0" ] || [ "$VERIFIED" = "null" ]; then
            echo "🚨 SLO VIOLATION: Zero/unknown cash! EMERGENCY ACTIONS:"
            
            # Boost everything
            ./_curl.sh "${{ env.BACKEND_URL }}/orchestrator/boost-intensity" POST '{"bid_boost_pct":20,"promo_boost_pct":25,"duration_minutes":120}' 30 2>/dev/null | jq -c '{ok}' || true
            
            # Shift to fast-converting SKUs
            ./_curl.sh "${{ env.BACKEND_URL }}/catalog/flip-to-fast-skus" POST '{"sku_tags":["express","quickturn","cart-recovery","low-ticket"]}' 30 2>/dev/null | jq -c '{ok}' || true
            
            # Pause low performers, boost top performers
            ./_curl.sh "${{ env.BACKEND_URL }}/orchestrator/mix-shift" POST '{"pause_bottom_decile":true,"reallocate_to_top_quartile":true}' 30 2>/dev/null | jq -c '{ok}' || true
            
            # Price elasticity - drop prices to drive volume
            ./_curl.sh "${{ env.BACKEND_URL }}/pricing/elasticity-stepdown" POST '{"steps":[-0.10,-0.15,-0.20],"channels":"all"}' 30 2>/dev/null | jq -c '{ok}' || true
            
            # Reactivate lapsed customers
            ./_curl.sh "${{ env.BACKEND_URL }}/retarget/reactivate-lapsed" POST '{"days":60,"cap":1000}' 60 2>/dev/null | jq -c '{ok}' || true
            
            # Burst recruitment
            ./_curl.sh "${{ env.BACKEND_URL }}/platform-recruitment/push" POST '{"burst":true,"targets":"all"}' 60 2>/dev/null | jq -c '{ok}' || true
            
            # Emergency social blast
            ./_curl.sh "${{ env.BACKEND_URL }}/viral/emergency-blast" POST '{"all_platforms":true}' 60 2>/dev/null | jq -c '{ok}' || true
            
            echo "slo_violated=1" >> $GITHUB_OUTPUT
          else
            echo "✅ SLO OK - Cash flow healthy ($VERIFIED)"
            echo "slo_violated=0" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 3: PROFIT GATE (Drop Low-Margin Work)
      # ═══════════════════════════════════════════════════════════════════════
      - name: ✅ Profit Gate (Margin Enforcement)
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "✅ PROFIT GATE - MARGIN ENFORCEMENT"
          echo "═══════════════════════════════════════════════════════════════"
          
          AGG="${{ steps.aggression.outputs.aggression }}"
          
          # Dynamic margin target based on aggression
          if [ "$AGG" -ge 8 ]; then
            MARGIN=0.15  # Low margin OK in beast mode
          elif [ "$AGG" -ge 5 ]; then
            MARGIN=0.25  # Normal margin
          else
            MARGIN=0.40  # High margin in optimize mode
          fi
          
          echo "Target margin: $MARGIN (aggression: $AGG)"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/pricing/optimize" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/execution/mark-unprofitable" POST "{\"target_margin\":$MARGIN}" 60 | jq -c '{ok,dropped}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 4: DEMAND VACUUM (Scrape Entire Internet)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🌪️ Demand Vacuum (27+ Platforms)
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🌪️ DEMAND VACUUM - SCRAPING THE INTERNET"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Master scrape
          ./_curl.sh "${{ env.BACKEND_URL }}/vacuum/scrape-all" POST '{"platforms":"all","depth":"deep"}' 300 | tee json/vacuum.json | jq -c '{ok,total_signals}' || true
          
          # Parallel platform scrapes
          ./_parallel.sh "${{ env.BACKEND_URL }}" \
            "/vacuum/fiverr" "/vacuum/upwork" "/vacuum/freelancer" "/vacuum/toptal" \
            "/vacuum/99designs" "/vacuum/designcrowd" "/vacuum/reddit" "/vacuum/twitter" \
            "/vacuum/linkedin" "/vacuum/discord" "/vacuum/producthunt"

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 5: REAL-TIME OPPORTUNITY SNIPER (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: ⚡ Real-Time Opportunity Sniper
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "⚡ REAL-TIME OPPORTUNITY SNIPER"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Check for fresh opportunities (posted in last 60 min)
          ./_curl.sh "${{ env.BACKEND_URL }}/sniper/fresh-opportunities" POST '{"max_age_minutes":60}' 60 | jq -c '{ok,count}' || true
          
          # Auto-bid on high-EV fresh opportunities
          ./_curl.sh "${{ env.BACKEND_URL }}/sniper/auto-bid" POST '{"min_ev":50,"max_bids":20}' 120 | jq -c '{ok,bids_placed}' || true
          
          # First-mover advantage tracking
          ./_curl.sh "${{ env.BACKEND_URL }}/sniper/first-mover-stats" GET '' 30 | jq -c '{ok,win_rate_boost}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 6: WADE AUTO-APPROVE & EXECUTE
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🤖 Wade Auto-Approve & Execute
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🤖 WADE AUTO-APPROVE & EXECUTE"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Dashboard
          ./_curl.sh "${{ env.BACKEND_URL }}/wade/dashboard" GET '' 30 | tee json/wade.json | jq -c '{ok,pending}' || true
          
          # Execution status
          ./_curl.sh "${{ env.BACKEND_URL }}/wade/execution-status" GET '' 30 | jq -c '{ok,total}' || true
          
          # AUTO-APPROVE ALL
          ./_curl.sh "${{ env.BACKEND_URL }}/wade/approve-all" POST '{}' 120 | tee json/wade-approve.json | jq -c '{ok,approved_count}' || true
          
          # Execute approved
          ./_curl.sh "${{ env.BACKEND_URL }}/wade/execute-approved" POST '{}' 180 | jq -c '{ok}' || true
          
          # Process discoveries
          ./_curl.sh "${{ env.BACKEND_URL }}/wade/process-discoveries" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 7: UNIVERSAL REVENUE ORCHESTRATOR
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💰 Universal Revenue Orchestrator
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💰 UNIVERSAL REVENUE ORCHESTRATOR"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/run-cycle" POST '{}' 300 | tee json/orch.json | jq -c '{ok,cycle_id}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/dashboard" GET '' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/revenue-summary?hours=24" GET '' 60 | jq -c '{ok,total}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/fiverr/process-orders" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/cart-recovery" POST '{}' 90 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/social/post-spawns" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue-orchestrator/arbitrage/find" POST '{}' 120 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 8: APEX UPGRADES (12 Revenue Optimization Modules)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🚀 Apex Upgrades (12 Modules)
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🚀 APEX UPGRADES - REVENUE OPTIMIZATION"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Intent Router + CAC Pricing
          ./_curl.sh "${{ env.BACKEND_URL }}/router/score-intent" POST '{"intent_id":"scan","signal":{"budget":500}}' 30 | jq -c '{ok,ev}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/router/route" POST '{"min_ev_usd":25}' 30 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/pricing/cac-aware" POST '{"base_price":200,"margin_target":0.55}' 30 | jq -c '{ok}' || true
          
          # Upsell + Recovery
          ./_curl.sh "${{ env.BACKEND_URL }}/upsell/recommend" POST '{"order_id":"scan"}' 30 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/recovery/compose" POST '{"order_ref":"scan"}' 30 | jq -c '{ok}' || true
          
          # LTV + Portfolio
          ./_curl.sh "${{ env.BACKEND_URL }}/ltv/predict" POST '{"client_id":"scan"}' 30 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/portfolio/rebalance" POST '{"auto":true}' 30 | jq -c '{ok}' || true
          
          # Churn + Proof
          ./_curl.sh "${{ env.BACKEND_URL }}/subscriptions/churn-risk" POST '{"sub_id":"scan"}' 30 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/proof/badge/mint" POST '{"deal_id":"auto"}' 30 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 9: AI SWARM INTELLIGENCE (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🐝 AI Swarm Intelligence
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🐝 AI SWARM INTELLIGENCE"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Run swarm competition
          ./_curl.sh "${{ env.BACKEND_URL }}/swarm/compete" POST '{"task_type":"all","workers":["claude","gpt4","perplexity"]}' 180 | jq -c '{ok,winner}' || true
          
          # Cross-learning
          ./_curl.sh "${{ env.BACKEND_URL }}/swarm/cross-learn" POST '{}' 60 | jq -c '{ok}' || true
          
          # MetaHive distribution
          ./_curl.sh "${{ env.BACKEND_URL }}/hive/distribute" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 10: PORTFOLIO KELLY CRITERION (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🎰 Portfolio Kelly Criterion
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🎰 PORTFOLIO KELLY CRITERION - OPTIMAL BET SIZING"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Calculate optimal allocations
          ./_curl.sh "${{ env.BACKEND_URL }}/kelly/calculate" POST '{}' 60 | jq -c '{ok,allocations}' || true
          
          # Apply allocations
          ./_curl.sh "${{ env.BACKEND_URL }}/kelly/apply" POST '{}' 60 | jq -c '{ok}' || true
          
          # Rebalance portfolio
          ./_curl.sh "${{ env.BACKEND_URL }}/kelly/rebalance" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 11: INSTANT ARBITRAGE
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💹 Instant Arbitrage
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💹 INSTANT ARBITRAGE"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/arbitrage/scan-all-markets" POST '{"min_profit_pct":15}' 120 | jq -c '{ok,opportunities}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/arbitrage/service-flip" POST '{"source":"fiverr","target":"upwork","markup":2.5}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/arbitrage/geo-exploit" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/arbitrage/execute-all" POST '{"min_roi":1.5}' 120 | jq -c '{ok,profit}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 12: MULTI-CURRENCY ARBITRAGE (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💱 Multi-Currency Arbitrage
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💱 MULTI-CURRENCY ARBITRAGE"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Scan FX opportunities
          ./_curl.sh "${{ env.BACKEND_URL }}/fx/scan-spreads" POST '{}' 60 | jq -c '{ok}' || true
          
          # Geo-aware pricing
          ./_curl.sh "${{ env.BACKEND_URL }}/fx/geo-price" POST '{"optimize":"revenue"}' 60 | jq -c '{ok}' || true
          
          # Auto-convert to strongest currency
          ./_curl.sh "${{ env.BACKEND_URL }}/fx/auto-convert" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 13: VIRAL CONTENT MACHINE
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🚀 Viral Content Machine
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🚀 VIRAL CONTENT MACHINE"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/viral/detect-trends" POST '{"platforms":"all"}' 60 | jq -c '{ok,trends}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/viral/generate-content" POST '{"formats":["short_video","carousel","thread"]}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/viral/cross-post" POST '{"platforms":["tiktok","instagram","twitter","linkedin"]}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/viral/engage" POST '{"strategy":"value_first"}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 14: PERPETUAL MOTION REVENUE (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🔄 Perpetual Motion Revenue
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔄 PERPETUAL MOTION REVENUE"
          echo "═══════════════════════════════════════════════════════════════"
          
          # For every completed deal, trigger 3 actions
          ./_curl.sh "${{ env.BACKEND_URL }}/perpetual/process-completions" POST '{}' 120 | jq -c '{ok}' || true
          
          # Auto-upsell
          ./_curl.sh "${{ env.BACKEND_URL }}/perpetual/auto-upsell" POST '{}' 60 | jq -c '{ok}' || true
          
          # Request referrals
          ./_curl.sh "${{ env.BACKEND_URL }}/perpetual/request-referrals" POST '{}' 60 | jq -c '{ok}' || true
          
          # Generate case studies -> content -> leads
          ./_curl.sh "${{ env.BACKEND_URL }}/perpetual/case-study-pipeline" POST '{}' 120 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 15: DEMAND WAVE RIDING (NEW!)
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🌊 Demand Wave Riding
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🌊 DEMAND WAVE RIDING"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Predict demand spikes
          ./_curl.sh "${{ env.BACKEND_URL }}/waves/predict" POST '{"horizon_hours":72}' 120 | jq -c '{ok,waves}' || true
          
          # Pre-position capacity
          ./_curl.sh "${{ env.BACKEND_URL }}/waves/pre-position" POST '{}' 60 | jq -c '{ok}' || true
          
          # Premium pricing for waves
          ./_curl.sh "${{ env.BACKEND_URL }}/waves/premium-pricing" POST '{}' 30 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 16: SPAWN ENGINE
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏭 Spawn Engine
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏭 SPAWN ENGINE"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/spawn/detect-trends" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/spawn/run-cycle" POST '{"max_spawns":10}' 300 | tee json/spawn.json | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/spawn/dashboard" GET '' 60 | jq -c '{ok,active}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/spawn/lifecycle-check" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/spawn/network/generate-promos" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 17: AFFILIATE SWARM
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🐝 Affiliate Swarm
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🐝 AFFILIATE SWARM"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/affiliate/generate-content" POST '{"networks":["amazon","shareasale","cj"]}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/affiliate/deploy-content" POST '{"targets":["medium","youtube"]}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/affiliate/optimize" POST '{}' 60 | jq -c '{ok,revenue}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 18: LEAD MAGNET FACTORY
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🧲 Lead Magnet Factory
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🧲 LEAD MAGNET FACTORY"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/leadmag/generate" POST '{"types":["ebook","checklist","template"]}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/leadmag/deploy-pages" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/leadmag/convert" POST '{}' 60 | jq -c '{ok,leads,conversions}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19: DISCOVERY + FULFILLMENT
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🔍 Discovery + Fulfillment
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔍 DISCOVERY + FULFILLMENT"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/execution/mega-discover" POST '{"enable_filters":true}' 300 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/autonomous/discover-and-execute" POST '{"auto_approve_user":true}' 180 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/fulfillment/process-queue" POST '{}' 180 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/fulfillment/auto-deliver" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/deals/advance-all" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19a: V99 SYSTEM CHECK
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🔬 V99 System Check
        id: v99check
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔬 V99 SYSTEM CHECK"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/v99/system-check" GET '' 30 | tee json/v99-check.json | jq -c '{summary}' 2>/dev/null || true
          ./_curl.sh "${{ env.BACKEND_URL }}/v99/quick-test" GET '' 30 | jq -c '{ok,steps}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19b: V99 REPLY DETECTION
      # ═══════════════════════════════════════════════════════════════════════
      - name: 📬 V99 Reply Detection
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📬 V99 REPLY DETECTION - MONITOR ALL CHANNELS"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Check all inboxes (Twitter DMs, Reddit inbox)
          ./_curl.sh "${{ env.BACKEND_URL }}/replies/check-all" POST '{}' 120 | jq -c '{ok,twitter_new,reddit_new}' 2>/dev/null || true
          
          # Get pending replies
          ./_curl.sh "${{ env.BACKEND_URL }}/replies/pending" GET '' 30 | jq -c '{ok,count}' 2>/dev/null || true
          
          # Get high-priority (interested) replies - HOT LEADS!
          ./_curl.sh "${{ env.BACKEND_URL }}/replies/high-priority" GET '' 30 | jq -c '{ok,count}' 2>/dev/null || true
          
          # Reply stats
          ./_curl.sh "${{ env.BACKEND_URL }}/replies/stats" GET '' 30 | tee json/v99-replies.json | jq -c '{ok}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19c: V99 PLATFORM ENGAGEMENT
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💬 V99 Platform Engagement
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💬 V99 PLATFORM ENGAGEMENT - COMMENT BEFORE DM"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Post helpful comments on discovered opportunities (warm-up)
          ./_curl.sh "${{ env.BACKEND_URL }}/engagement/respond-batch" POST '{"max_comments":10}' 180 | jq -c '{ok,commented,failed}' 2>/dev/null || true
          
          # Process pending DMs (where warm-up delay has passed)
          ./_curl.sh "${{ env.BACKEND_URL }}/engagement/process-pending-dms" POST '{}' 120 | jq -c '{ok,ready,sent}' 2>/dev/null || true
          
          # Get engagement stats
          ./_curl.sh "${{ env.BACKEND_URL }}/engagement/stats" GET '' 30 | tee json/v99-engagement.json | jq -c '{ok}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19d: V99 CONVERSATION AI
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🗣️ V99 Conversation AI
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🗣️ V99 CONVERSATION AI - MULTI-TURN CLOSING"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Auto-process pending replies and generate AI responses
          ./_curl.sh "${{ env.BACKEND_URL }}/conversation/auto-process-replies" POST '{}' 180 | jq -c '{ok,processed,responses_generated}' 2>/dev/null || true
          
          # Get hot leads (conversations close to closing)
          ./_curl.sh "${{ env.BACKEND_URL }}/conversations/hot-leads" GET '' 30 | jq -c '{ok,count,total_potential_value}' 2>/dev/null || true
          
          # Conversation stats
          ./_curl.sh "${{ env.BACKEND_URL }}/conversations/stats" GET '' 30 | tee json/v99-conversations.json | jq -c '{ok}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19e: V99 CONTRACT & DEPOSIT
      # ═══════════════════════════════════════════════════════════════════════
      - name: 📝 V99 Contract & Deposit
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📝 V99 CONTRACT & DEPOSIT - AUTO-CLOSE DEALS"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Auto-send contracts to conversations in CLOSING stage
          ./_curl.sh "${{ env.BACKEND_URL }}/contract/auto-send-for-closing" POST '{}' 180 | jq -c '{ok,contracts_created,contracts_sent}' 2>/dev/null || true
          
          # Check pending payments
          ./_curl.sh "${{ env.BACKEND_URL }}/contracts/pending-payments" GET '' 30 | jq -c '{ok,count,total_pending}' 2>/dev/null || true
          
          # Contract stats
          ./_curl.sh "${{ env.BACKEND_URL }}/contracts/stats" GET '' 30 | tee json/v99-contracts.json | jq -c '{ok}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 19f: V99 FULL AUTONOMOUS CYCLE
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🔄 V99 Full Autonomous Cycle
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🔄 V99 FULL AUTONOMOUS CYCLE"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Run the complete v99 pipeline in one call
          ./_curl.sh "${{ env.BACKEND_URL }}/autonomous/full-cycle-v99" POST '{}' 300 | tee json/v99-cycle.json | jq -c '{ok,summary}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 20: AI GENERATION
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🤖 AI Generation
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🤖 AI GENERATION"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/ai/orchestrate" POST '{}' 300 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/graphics/batch-generate" POST '{}' 300 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/audio/batch-generate" POST '{}' 300 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/video/batch-generate" POST '{}' 300 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 21: FINANCIAL
      # ═══════════════════════════════════════════════════════════════════════
      - name: 💳 Financial Systems
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "💳 FINANCIAL SYSTEMS"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/stripe/batch-payouts" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/revenue/reconcile" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/escrow/auto-release" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/payments/batch-execute" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/subscriptions/process-renewals" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/ipvault/royalty-sweep" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 22: MARKETING
      # ═══════════════════════════════════════════════════════════════════════
      - name: 📣 Marketing
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "📣 MARKETING"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/email/send-batch" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/ame/process-queue" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/ame/generate-pitches" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/social/process-queue" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/retarget/process-queue" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 23: PLATFORM + META
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🎨 Platform + Meta
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🎨 PLATFORM + META"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/fiverr/process-orders" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/dribbble/post-daily" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/99designs/scan-and-enter" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/metabridge/batch_execute" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/darkpool/match" POST '{}' 60 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 24: LEARNING + SELF-HEALING
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🧠 Learning + Self-Healing
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🧠 LEARNING + SELF-HEALING"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/learning/process-outcomes" POST '{}' 120 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/learning/update-models" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/orchestrator/circuits" GET '' 30 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/orchestrator/auto-recover" POST '{}' 60 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/reconciliation/persist" POST '{}' 30 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 25: 🏦 PROFIT ENGINE - ROI Kill Switch
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏦 Profit Engine - ROI Kill Switch
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏦 PROFIT ENGINE - ROI KILL SWITCH"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Get active campaigns and check ROI
          ./_curl.sh "${{ env.BACKEND_URL }}/r3/campaigns/active" GET '' 30 | jq -c '{ok,active_count,killed_count}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 26: 🏦 PROFIT ENGINE - Recovery Cadence
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏦 Profit Engine - Recovery Cadence
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏦 PROFIT ENGINE - RECOVERY CADENCE (T+15m/T+23h/T+3d)"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Process recovery queue
          ./_curl.sh "${{ env.BACKEND_URL }}/recovery/process" POST '{}' 60 | jq -c '{ok,touches_sent,pending}' 2>/dev/null || true
          
          # Get recovery stats
          ./_curl.sh "${{ env.BACKEND_URL }}/recovery/stats" GET '' 30 | jq -c '{ok,recovery_rate,meets_gate}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 27: 🏦 PROFIT ENGINE - Pricing Bandit
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏦 Profit Engine - Pricing Bandit
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏦 PROFIT ENGINE - PRICING BANDIT (Thompson Sampling)"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Get leaderboard for each segment
          ./_curl.sh "${{ env.BACKEND_URL }}/pricing/bandit/leaderboard?segment=default" GET '' 30 | jq -c '{ok,leaderboard}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 28: 🏦 PROFIT ENGINE - Experiment Factory
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏦 Profit Engine - Experiment Factory
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏦 PROFIT ENGINE - EXPERIMENT FACTORY (10/segment/day)"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Auto-create experiments for default segment
          ./_curl.sh "${{ env.BACKEND_URL }}/experiments/auto-create" POST '{"segment":"default","count":10}' 60 | jq -c '{ok,created,total_running}' 2>/dev/null || true
          
          # Evaluate and retire/scale experiments
          ./_curl.sh "${{ env.BACKEND_URL }}/experiments/evaluate" POST '{}' 60 | jq -c '{ok,winners,losers}' 2>/dev/null || true
          
          # Get dashboard
          ./_curl.sh "${{ env.BACKEND_URL }}/experiments/dashboard" GET '' 30 | jq -c '{ok,win_rate,meets_gate}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 29: 🏦 PROFIT ENGINE - Backpressure Status
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏦 Profit Engine - Backpressure
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏦 PROFIT ENGINE - BACKPRESSURE STATUS"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Check slot utilization
          ./_curl.sh "${{ env.BACKEND_URL }}/backpressure/status" GET '' 30 | jq -c '{ok,slots}' 2>/dev/null || true

      # ═══════════════════════════════════════════════════════════════════════
      # PHASE 30: HEALTH CHECKS
      # ═══════════════════════════════════════════════════════════════════════
      - name: 🏥 Health Checks
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "🏥 HEALTH CHECKS"
          echo "═══════════════════════════════════════════════════════════════"
          
          ./_curl.sh "${{ env.BACKEND_URL }}/health" GET '' 10 | jq -c '{status}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/execution/health" GET '' 10 | jq -c '{ok}' || true
          ./_curl.sh "${{ env.BACKEND_URL }}/learning/health" GET '' 10 | jq -c '{ok}' || true

      # ═══════════════════════════════════════════════════════════════════════
      # CANARY ARTIFACT
      # ═══════════════════════════════════════════════════════════════════════
      - name: 📦 Revenue Canary Artifact
        if: always()
        run: |
          NOW=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          DASH=$(cat json/orch.json 2>/dev/null || echo '{}')
          WADE=$(cat json/wade-approve.json 2>/dev/null || echo '{}')
          SPAWN=$(cat json/spawn.json 2>/dev/null || echo '{}')
          V99_CHECK=$(cat json/v99-check.json 2>/dev/null || echo '{}')
          V99_CYCLE=$(cat json/v99-cycle.json 2>/dev/null || echo '{}')
          V99_REPLIES=$(cat json/v99-replies.json 2>/dev/null || echo '{}')
          V99_CONTRACTS=$(cat json/v99-contracts.json 2>/dev/null || echo '{}')
          
          cat > canary.json <<EOF
          {
            "ts": "$NOW",
            "version": "v99",
            "cash": {
              "verified_6h": "${{ steps.cash.outputs.verified_6h }}",
              "scheduled_24h": "${{ steps.cash.outputs.scheduled_24h }}",
              "pipeline": "${{ steps.cash.outputs.pipeline }}",
              "mrr": "${{ steps.cash.outputs.mrr }}"
            },
            "aggression": {
              "level": "${{ steps.aggression.outputs.aggression }}",
              "mode": "${{ steps.aggression.outputs.mode }}"
            },
            "slo_violated": "${{ steps.slo.outputs.slo_violated }}",
            "orchestrator": $DASH,
            "wade": $WADE,
            "spawn": $SPAWN,
            "v99": {
              "system_check": $V99_CHECK,
              "cycle": $V99_CYCLE,
              "replies": $V99_REPLIES,
              "contracts": $V99_CONTRACTS
            }
          }
          EOF

      - name: ⬆️ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autonomous-closing-v99-${{ github.run_number }}
          path: |
            canary.json
            json/
          retention-days: 14

      # ═══════════════════════════════════════════════════════════════════════
      # SUMMARY
      # ═══════════════════════════════════════════════════════════════════════
      - name: 📝 Summary
        if: always()
        run: |
          echo ""
          echo "╔═══════════════════════════════════════════════════════════════════╗"
          echo "║       🏦 AIGENTSY v99 AUTONOMOUS CLOSING - COMPLETE               ║"
          echo "╠═══════════════════════════════════════════════════════════════════╣"
          echo "║ 🕐 $(date -u '+%Y-%m-%d %H:%M:%S UTC')                             ║"
          echo "╠═══════════════════════════════════════════════════════════════════╣"
          echo "║ 💓 CASH: verified=\$${{ steps.cash.outputs.verified_6h }} | sched=\$${{ steps.cash.outputs.scheduled_24h }}"
          echo "║ 📊 PIPELINE: \$${{ steps.cash.outputs.pipeline }} | MRR: \$${{ steps.cash.outputs.mrr }}"
          echo "║ ⚡ AGGRESSION: ${{ steps.aggression.outputs.aggression }}/10 (${{ steps.aggression.outputs.mode }})"
          echo "║ 🚨 SLO VIOLATED: ${{ steps.slo.outputs.slo_violated }}"
          echo "╠═══════════════════════════════════════════════════════════════════╣"
          echo "║ 📬 V99 AUTONOMOUS CLOSING PIPELINE:                               ║"
          echo "║   📬 Reply Detection (Resend webhooks + inbox polling)            ║"
          echo "║   💬 Platform Engagement (comment before DM)                      ║"
          echo "║   🗣️ Conversation AI (qualify, objections, close)                 ║"
          echo "║   📝 Contract + Deposit (Stripe Payment Links)                    ║"
          echo "╠═══════════════════════════════════════════════════════════════════╣"
          echo "║ 🏦 v98 PROFIT ENGINE SYSTEMS:                                     ║"
          echo "║   💀 ROI Kill Switch (gate=1.6x, kill=1.2x)                       ║"
          echo "║   🔑 Unified Idempotency (dedupe across pipeline)                 ║"
          echo "║   👤 Strict Ownership (deterministic assignment)                  ║"
          echo "║   🚦 Backpressure + Priorities (reserved slots)                   ║"
          echo "║   🎰 Pricing Bandit (Thompson sampling)                           ║"
          echo "║   📧 Recovery Cadence (T+15m/T+23h/T+3d)                          ║"
          echo "║   🧪 Experiment Factory (10/segment/day)                          ║"
          echo "╠═══════════════════════════════════════════════════════════════════╣"
          echo "║ 📈 TOTAL: 320+ ENDPOINTS | 36 PHASES | EVERY 15 MINUTES           ║"
          echo "╚═══════════════════════════════════════════════════════════════════╝"
