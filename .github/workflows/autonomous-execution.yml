name: Autonomous Execution - Production v3 (Apex)

on:
  schedule:
    # Every 15 minutes (96 cycles/day)
    - cron: '*/15 * * * *'

  # Manual trigger with apex options
  workflow_dispatch:
    inputs:
      max_opportunities:
        description: 'Max opportunities to process'
        required: false
        default: '100'
      auto_execute:
        description: 'Auto-execute contracts'
        required: false
        default: 'true'
      use_fa30:
        description: 'Use FA30 (First Artifact in 30 min)'
        required: false
        default: 'true'
      use_dual_track:
        description: 'Use dual-track execution (PoC + Outreach)'
        required: false
        default: 'true'
      use_similarity:
        description: 'Use execution similarity learning'
        required: false
        default: 'true'

env:
  RUNTIME_URL: https://aigentsy-ame-runtime.onrender.com
  MIN_SYSTEMS_REQUIRED: 45
  FA30_TIMEOUT_MINUTES: 35

jobs:
  # ============================================================================
  # PRE-FLIGHT: Health Check with Apex Systems Validation
  # ============================================================================
  health-check:
    name: Pre-flight Health Check (Apex Systems)
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      systems_loaded: ${{ steps.health.outputs.systems }}
      apex_ready: ${{ steps.apex.outputs.ready }}
      capacity_available: ${{ steps.capacity.outputs.available }}

    steps:
      - name: Check Integration Health
        id: health
        run: |
          HEALTH=$(curl -s ${{ env.RUNTIME_URL }}/integration/health)

          SYSTEMS=$(echo "$HEALTH" | jq -r '.systems_health.loaded // 0')
          TOTAL=$(echo "$HEALTH" | jq -r '.systems_health.total // 47')
          STATUS=$(echo "$HEALTH" | jq -r '.status')
          COVERAGE=$(echo "$HEALTH" | jq -r '.systems_health.coverage_pct // 0')

          echo "systems=$SYSTEMS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

          echo "ğŸ“Š System Health:"
          echo "   Status: $STATUS"
          echo "   Systems: $SYSTEMS/$TOTAL ($COVERAGE%)"

          if [ "$STATUS" != "healthy" ]; then
            echo "âŒ System unhealthy: $STATUS"
            exit 1
          fi

          if [ "$SYSTEMS" -lt ${{ env.MIN_SYSTEMS_REQUIRED }} ]; then
            echo "âš ï¸ Insufficient systems: $SYSTEMS < ${{ env.MIN_SYSTEMS_REQUIRED }}"
            exit 1
          fi

          echo "âœ… System healthy"

      - name: Verify Apex Systems
        id: apex
        run: |
          echo "ğŸ” Checking Apex Upgrade Systems..."

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          # Check key apex components
          ORCHESTRATOR=$(echo "$STATS" | jq -r '.stats.orchestrator // empty')
          ESCROW=$(echo "$STATS" | jq -r '.stats.escrow // empty')
          WORKFORCE=$(echo "$STATS" | jq -r '.stats.workforce // empty')

          APEX_READY="true"

          if [ -z "$ORCHESTRATOR" ]; then
            echo "âš ï¸ Orchestrator not loaded"
            APEX_READY="false"
          else
            echo "âœ… Fulfillment Orchestrator: Active"
          fi

          if [ -z "$ESCROW" ]; then
            echo "âš ï¸ Milestone Escrow not loaded"
            APEX_READY="false"
          else
            echo "âœ… Milestone Escrow: Active"
          fi

          if [ -z "$WORKFORCE" ]; then
            echo "âš ï¸ Workforce Dispatcher not loaded"
            APEX_READY="false"
          else
            echo "âœ… Workforce Dispatcher: Active"
          fi

          echo "ready=$APEX_READY" >> $GITHUB_OUTPUT

      - name: Check Workforce Capacity
        id: capacity
        run: |
          CAPACITY=$(curl -s ${{ env.RUNTIME_URL }}/integration/capacity)

          TOTAL_SLOTS=$(echo "$CAPACITY" | jq -r '.capacity.total_capacity // 100')
          AVAILABLE=$(echo "$CAPACITY" | jq -r '.capacity.total_available // 100')
          UTILIZATION=$(echo "$CAPACITY" | jq -r '.capacity.utilization_percentage // 0')

          echo "ğŸ“Š Workforce Capacity:"
          echo "   Total slots: $TOTAL_SLOTS"
          echo "   Available: $AVAILABLE"
          echo "   Utilization: $UTILIZATION%"

          echo "available=$AVAILABLE" >> $GITHUB_OUTPUT
          echo "utilization=$UTILIZATION" >> $GITHUB_OUTPUT

          # Hard gate: Don't run if capacity is exhausted
          if [ "$AVAILABLE" -lt 5 ]; then
            echo "âš ï¸ Low capacity: Only $AVAILABLE slots available"
            echo "   Skipping cycle to prevent overload"
            exit 1
          fi

      - name: Check Customer Loop Status (Multi-Channel)
        id: customer_loop
        run: |
          echo "ğŸ”— Checking Multi-Channel Customer Loop..."

          LOOP_STATUS=$(curl -s ${{ env.RUNTIME_URL }}/integration/customer-loop-status)

          CAN_PRESENT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_present_contracts // false')
          CAN_ACCEPT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_accept_payments // false')
          CHANNEL_COUNT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.channel_count // 0')
          CONFIGURED_APIS=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.api_key_summary.configured // 0')
          TOTAL_APIS=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.api_key_summary.total // 0')

          echo "ğŸ“Š Customer Loop Status:"
          echo "   Can present contracts: $CAN_PRESENT"
          echo "   Can accept payments: $CAN_ACCEPT"
          echo "   Configured channels: $CHANNEL_COUNT"
          echo "   API Keys: $CONFIGURED_APIS/$TOTAL_APIS configured"

          echo "can_present=$CAN_PRESENT" >> $GITHUB_OUTPUT
          echo "can_accept=$CAN_ACCEPT" >> $GITHUB_OUTPUT
          echo "channel_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT

          # Show channel categories
          echo ""
          echo "ğŸ“§ Outreach Channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.outreach_channels[]' 2>/dev/null | while read ch; do echo "   â€¢ $ch"; done

          echo ""
          echo "ğŸ’¬ Comment Channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.comment_channels[]' 2>/dev/null | while read ch; do echo "   â€¢ $ch"; done

          echo ""
          echo "ğŸ’³ Payment Channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.payment_channels[]' 2>/dev/null | while read ch; do echo "   â€¢ $ch"; done

          echo ""
          echo "ğŸ¤– AI Channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.ai_channels[]' 2>/dev/null | while read ch; do echo "   â€¢ $ch"; done

          echo ""
          echo "ğŸ”Œ Loaded Connectors:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.connectors_loaded[]' 2>/dev/null | while read conn; do echo "   â€¢ $conn"; done

          if [ "$CAN_PRESENT" = "false" ]; then
            echo ""
            echo "âš ï¸ Warning: No outreach channels configured"
            echo "   Set RESEND_API_KEY for email or TWILIO_* for SMS"
          fi

          if [ "$CAN_ACCEPT" = "false" ]; then
            echo "âš ï¸ Warning: Stripe not configured"
            echo "   Set STRIPE_SECRET_KEY to enable payment collection"
          fi

          RECOMMENDATION=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.recommendation // "No recommendation"')
          echo ""
          echo "ğŸ“‹ Recommendation: $RECOMMENDATION"

  # ============================================================================
  # MAIN: Full-Stack Autonomous Cycle with Apex Features
  # ============================================================================
  autonomous-cycle:
    name: Apex Autonomous Cycle
    runs-on: ubuntu-latest
    needs: health-check
    timeout-minutes: 20
    outputs:
      discovered: ${{ steps.execute.outputs.discovered }}
      contracts: ${{ steps.execute.outputs.contracts }}
      revenue: ${{ steps.execute.outputs.revenue }}
      fa30_triggered: ${{ steps.execute.outputs.fa30_triggered }}
      dual_track_used: ${{ steps.execute.outputs.dual_track_used }}
      presented: ${{ steps.execute.outputs.presented }}
      presentation_method: ${{ steps.execute.outputs.presentation_method }}

    steps:
      - name: Check Execution Similarity (Pre-flight Learning)
        id: similarity
        if: ${{ github.event.inputs.use_similarity != 'false' }}
        run: |
          echo "ğŸ§  Checking execution similarity for learning insights..."

          # Get recent execution patterns
          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          RECENT_SUCCESS_RATE=$(echo "$STATS" | jq -r '.stats.workforce.success_rate // 0.8')
          AVG_DURATION=$(echo "$STATS" | jq -r '.stats.workforce.avg_completion_minutes // 30')

          echo "ğŸ“Š Historical Patterns:"
          echo "   Success rate: $RECENT_SUCCESS_RATE"
          echo "   Avg duration: ${AVG_DURATION}m"

          # Adjust strategy based on patterns
          if (( $(echo "$RECENT_SUCCESS_RATE < 0.6" | bc -l) )); then
            echo "âš ï¸ Low success rate - enabling conservative mode"
            echo "conservative=true" >> $GITHUB_OUTPUT
          else
            echo "conservative=false" >> $GITHUB_OUTPUT
          fi

      - name: Execute Discovery â†’ Contract â†’ Fulfill Pipeline
        id: execute
        run: |
          MAX_OPPS="${{ github.event.inputs.max_opportunities || '10' }}"
          AUTO_EXEC="${{ github.event.inputs.auto_execute || 'true' }}"
          USE_FA30="${{ github.event.inputs.use_fa30 || 'true' }}"
          USE_DUAL_TRACK="${{ github.event.inputs.use_dual_track || 'true' }}"

          echo "ğŸš€ Starting Apex Autonomous Cycle..."
          echo "   Max opportunities: $MAX_OPPS"
          echo "   Auto-execute: $AUTO_EXEC"
          echo "   FA30 enabled: $USE_FA30"
          echo "   Dual-track enabled: $USE_DUAL_TRACK"
          echo ""

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            ${{ env.RUNTIME_URL }}/integration/discover-and-execute \
            -H "Content-Type: application/json" \
            -d "{
              \"max_opportunities\": $MAX_OPPS,
              \"auto_execute\": $AUTO_EXEC,
              \"apex_options\": {
                \"fa30_enabled\": $USE_FA30,
                \"dual_track_enabled\": $USE_DUAL_TRACK,
                \"use_hot_start_kits\": true,
                \"use_execution_similarity\": true,
                \"multilingual_outreach\": true
              },
              \"trigger\": \"github_actions_apex_v3\",
              \"run_id\": \"${{ github.run_id }}\",
              \"run_number\": ${{ github.run_number }}
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Pipeline failed with HTTP $HTTP_CODE"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 1
          fi

          # Extract core metrics
          DISCOVERED=$(echo "$BODY" | jq -r '.results.steps.discovery.count // .results.opportunities_processed // 0')
          DISCOVERY_SOURCE=$(echo "$BODY" | jq -r '.results.steps.discovery.source // "unknown"')
          WITH_CONTACT=$(echo "$BODY" | jq -r '.results.steps.discovery.with_contact // 0')
          CONTACT_RATE=$(echo "$BODY" | jq -r '.results.steps.discovery.contact_rate // "0%"')
          CONTRACTS=$(echo "$BODY" | jq -r '.results.steps.contracts.count // .results.contracts_created // 0')
          DISPATCHED=$(echo "$BODY" | jq -r '.results.steps.dispatch.tasks // .results.tasks_dispatched // 0')
          REVENUE=$(echo "$BODY" | jq -r '.results.contracts[0].escrow.total_amount_usd // 0')

          # Extract apex metrics
          FA30_TRIGGERED=$(echo "$BODY" | jq -r '.results.apex.fa30_contracts_created // 0')
          DUAL_TRACK_USED=$(echo "$BODY" | jq -r '.results.apex.dual_track_executions // 0')
          HOT_STARTS=$(echo "$BODY" | jq -r '.results.apex.hot_start_kits_applied // 0')
          LANGUAGES=$(echo "$BODY" | jq -r '.results.apex.languages_detected // "en"')

          # Extract customer loop / presentation metrics
          PRESENTED=$(echo "$BODY" | jq -r '.results.steps.presentation.presented // 0')
          PRESENTATION_TOTAL=$(echo "$BODY" | jq -r '.results.steps.presentation.total // 0')
          PRESENTATION_METHOD=$(echo "$BODY" | jq -r '.results.presentations[0].method // "none"')

          echo "discovered=$DISCOVERED" >> $GITHUB_OUTPUT
          echo "contracts=$CONTRACTS" >> $GITHUB_OUTPUT
          echo "dispatched=$DISPATCHED" >> $GITHUB_OUTPUT
          echo "revenue=$REVENUE" >> $GITHUB_OUTPUT
          echo "fa30_triggered=$FA30_TRIGGERED" >> $GITHUB_OUTPUT
          echo "dual_track_used=$DUAL_TRACK_USED" >> $GITHUB_OUTPUT
          echo "presented=$PRESENTED" >> $GITHUB_OUTPUT
          echo "presentation_method=$PRESENTATION_METHOD" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… APEX CYCLE COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Discovery (Hybrid):"
          echo "   Source: $DISCOVERY_SOURCE"
          echo "   Discovered: $DISCOVERED opportunities"
          echo "   With contact: $WITH_CONTACT ($CONTACT_RATE)"
          echo ""
          echo "ğŸ“Š Core Metrics:"
          echo "   Contracts: $CONTRACTS created"
          echo "   Dispatched: $DISPATCHED tasks"
          echo "   Revenue: \$$REVENUE"
          echo ""
          echo "ğŸ”— Customer Loop:"
          echo "   Contracts presented: $PRESENTED / $PRESENTATION_TOTAL"
          echo "   Primary method: $PRESENTATION_METHOD"
          echo ""
          echo "ğŸš€ Apex Features Used:"
          echo "   FA30 contracts: $FA30_TRIGGERED"
          echo "   Dual-track executions: $DUAL_TRACK_USED"
          echo "   Hot-start kits: $HOT_STARTS"
          echo "   Languages: $LANGUAGES"
          echo ""

      - name: Monitor FA30 Artifacts (if triggered)
        if: steps.execute.outputs.fa30_triggered != '0'
        run: |
          echo "â±ï¸ FA30 Monitoring: Checking for first artifacts..."

          # FA30 promises first artifact in 30 minutes
          # Check progress after brief wait
          sleep 30

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          FA30_DELIVERED=$(echo "$STATS" | jq -r '.stats.fa30.artifacts_delivered // 0')
          FA30_PENDING=$(echo "$STATS" | jq -r '.stats.fa30.artifacts_pending // 0')
          AVG_DELIVERY_TIME=$(echo "$STATS" | jq -r '.stats.fa30.avg_delivery_minutes // 0')

          echo "ğŸ“¦ FA30 Status:"
          echo "   Delivered: $FA30_DELIVERED"
          echo "   Pending: $FA30_PENDING"
          echo "   Avg delivery: ${AVG_DELIVERY_TIME}m"

          if [ "$FA30_DELIVERED" -gt 0 ]; then
            echo "âœ… FA30 SLA met: Artifacts delivered"
          fi

      - name: Validate Results & Calculate Metrics
        run: |
          DISCOVERED=${{ steps.execute.outputs.discovered }}
          CONTRACTS=${{ steps.execute.outputs.contracts }}
          REVENUE=${{ steps.execute.outputs.revenue }}

          echo "ğŸ“ˆ Performance Analysis:"

          # Conversion rate
          if [ "$DISCOVERED" -gt 0 ]; then
            CONVERSION=$(echo "scale=1; $CONTRACTS * 100 / $DISCOVERED" | bc)
            echo "   Conversion rate: ${CONVERSION}%"

            if (( $(echo "$CONVERSION < 10" | bc -l) )); then
              echo "   âš ï¸ Low conversion - review routing scores"
            fi
          fi

          # Average contract value
          if [ "$CONTRACTS" -gt 0 ]; then
            AVG_VALUE=$(echo "scale=2; $REVENUE / $CONTRACTS" | bc)
            echo "   Avg contract value: \$$AVG_VALUE"
          fi

          # Revenue per opportunity
          if [ "$DISCOVERED" -gt 0 ]; then
            RPO=$(echo "scale=2; $REVENUE / $DISCOVERED" | bc)
            echo "   Revenue per opportunity: \$$RPO"
          fi

  # ============================================================================
  # POST-CYCLE: Statistics & Apex Dashboard
  # ============================================================================
  post-cycle-stats:
    name: Post-Cycle Statistics (Apex Dashboard)
    runs-on: ubuntu-latest
    needs: autonomous-cycle
    if: always()
    timeout-minutes: 5

    steps:
      - name: Collect Comprehensive Stats
        id: stats
        run: |
          echo "ğŸ“Š Collecting comprehensive statistics..."

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š FULL SYSTEM STATISTICS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "$STATS" | jq '{
            systems: {
              loaded: .stats.systems.total_loaded,
              engines: .stats.systems.engines_loaded,
              oracles: .stats.systems.oracles_loaded,
              brain: .stats.systems.brain_loaded
            },
            contracts: {
              total_created: .stats.escrow.contracts_created,
              total_value_usd: .stats.escrow.total_value_usd,
              milestones_funded: .stats.escrow.milestones_funded,
              milestones_released: .stats.escrow.milestones_released
            },
            workforce: {
              tasks_dispatched: .stats.workforce.tasks_dispatched,
              tasks_completed: .stats.workforce.tasks_completed,
              fabric_tasks: .stats.workforce.fabric_tasks,
              human_tasks: .stats.workforce.human_tasks
            },
            orchestrator: {
              plans_created: .stats.orchestrator.plans_created,
              plans_completed: .stats.orchestrator.plans_completed,
              runbooks_loaded: .stats.orchestrator.runbooks_loaded
            }
          }'

      - name: Check Workforce Capacity (Post-Cycle)
        run: |
          CAPACITY=$(curl -s ${{ env.RUNTIME_URL }}/integration/capacity)

          echo ""
          echo "ğŸ‘· Workforce Status:"
          echo "$CAPACITY" | jq '{
            total_capacity: .capacity.total_capacity,
            available: .capacity.total_available,
            utilization_pct: .capacity.utilization_percentage,
            by_tier: .capacity.by_tier
          }'

      - name: Check Client Room Activity
        run: |
          echo ""
          echo "ğŸ  Client Room Status:"
          echo "   Endpoint: ${{ env.RUNTIME_URL }}/client-room/{contract_id}"
          echo "   Features: Green Light Timeline, Milestone Tracking, Live Previews"

      - name: Check Wall of Wins
        run: |
          echo ""
          echo "ğŸ† Wall of Wins:"

          WINS=$(curl -s ${{ env.RUNTIME_URL }}/integration/wall-of-wins)

          WIN_COUNT=$(echo "$WINS" | jq -r '.count // 0')
          TOTAL_REVENUE=$(echo "$WINS" | jq -r '.total_revenue_usd // 0')
          echo "   Completed contracts: $WIN_COUNT"
          echo "   Total revenue collected: \$$TOTAL_REVENUE"

          if [ "$WIN_COUNT" -gt 0 ]; then
            echo "   Recent wins:"
            echo "$WINS" | jq -r '.wall_of_wins[:3][] | "     - \(.title): $\(.revenue_usd)"' 2>/dev/null || true
          fi

      - name: Check Customer Loop Status (Post-Cycle)
        run: |
          echo ""
          echo "ğŸ”— Multi-Channel Customer Loop Status:"

          LOOP_STATUS=$(curl -s ${{ env.RUNTIME_URL }}/integration/customer-loop-status)

          CAN_PRESENT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_present_contracts // false')
          CAN_ACCEPT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_accept_payments // false')
          CHANNEL_COUNT=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.channel_count // 0')

          echo "   Can present contracts: $CAN_PRESENT"
          echo "   Can accept payments: $CAN_ACCEPT"
          echo "   Active channels: $CHANNEL_COUNT"

          # Show channel breakdown by type
          echo ""
          echo "   ğŸ“§ Email channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.configured_channels[] | select(startswith("email:"))' 2>/dev/null | while read ch; do echo "      â€¢ $ch"; done

          echo "   ğŸ“± SMS/Voice channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.configured_channels[] | select(startswith("sms:") or startswith("whatsapp:"))' 2>/dev/null | while read ch; do echo "      â€¢ $ch"; done

          echo "   ğŸ’¬ Social DM channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.configured_channels[] | select(startswith("dm:") or startswith("message:"))' 2>/dev/null | while read ch; do echo "      â€¢ $ch"; done

          echo "   ğŸ’³ Payment channels:"
          echo "$LOOP_STATUS" | jq -r '.customer_loop.configured_channels[] | select(startswith("payment:"))' 2>/dev/null | while read ch; do echo "      â€¢ $ch"; done

          # Check presentation history
          RECENT=$(echo "$LOOP_STATUS" | jq -r '.presentation_history.total_executions // 0')
          echo ""
          echo "   Total presentation attempts: $RECENT"

          RECOMMENDATION=$(echo "$LOOP_STATUS" | jq -r '.customer_loop.recommendation // "None"')
          echo "   ğŸ“‹ Recommendation: $RECOMMENDATION"

      - name: Check Shadow Selector Health
        run: |
          echo ""
          echo "ğŸ” Shadow Selector Status:"
          echo "   Auto-cutover threshold: 0.9 confidence"
          echo "   Min trials before cutover: 5"
          # Would query selector_healer stats endpoint if available

      - name: Check Two-Rail Milestone Stats
        run: |
          echo ""
          echo "ğŸ’³ Two-Rail Milestone Stats:"
          echo "   Rails: Cash, Credit+AIGx (5% premium)"
          # Would query milestone stats endpoint if available

  # ============================================================================
  # SLO MONITORING: Track Key SLAs
  # ============================================================================
  slo-monitoring:
    name: SLO Monitoring
    runs-on: ubuntu-latest
    needs: autonomous-cycle
    if: always()
    timeout-minutes: 3

    steps:
      - name: Check FA30 SLO (30-minute first artifact)
        run: |
          echo "â±ï¸ FA30 SLO Check:"
          echo "   Target: First artifact in 30 minutes"

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          FA30_MET=$(echo "$STATS" | jq -r '.stats.fa30.slo_met_count // 0')
          FA30_MISSED=$(echo "$STATS" | jq -r '.stats.fa30.slo_missed_count // 0')

          if [ "$FA30_MET" -gt 0 ] || [ "$FA30_MISSED" -gt 0 ]; then
            TOTAL=$((FA30_MET + FA30_MISSED))
            SLO_PCT=$(echo "scale=1; $FA30_MET * 100 / $TOTAL" | bc)
            echo "   SLO compliance: ${SLO_PCT}% ($FA30_MET/$TOTAL)"
          else
            echo "   No FA30 contracts this cycle"
          fi

      - name: Check Dual-Track SLO (parallel efficiency)
        run: |
          echo ""
          echo "ğŸ”€ Dual-Track SLO Check:"
          echo "   Target: PoC + Outreach complete within 2x single-track time"
          # Would query dual-track stats

      - name: Check Discovery SLO (opportunities found)
        run: |
          echo ""
          echo "ğŸ” Discovery SLO Check:"
          echo "   Target: >5 opportunities per cycle"

          DISCOVERED=${{ needs.autonomous-cycle.outputs.discovered }}

          if [ "$DISCOVERED" -ge 5 ]; then
            echo "   âœ… SLO met: $DISCOVERED opportunities"
          else
            echo "   âš ï¸ SLO missed: $DISCOVERED < 5 opportunities"
          fi

      - name: Check Capacity SLO (avoid exhaustion)
        run: |
          echo ""
          echo "ğŸ“Š Capacity SLO Check:"
          echo "   Target: <80% utilization"

          CAPACITY=$(curl -s ${{ env.RUNTIME_URL }}/integration/capacity)
          UTILIZATION=$(echo "$CAPACITY" | jq -r '.capacity.utilization_percentage // 0')

          if (( $(echo "$UTILIZATION < 80" | bc -l) )); then
            echo "   âœ… SLO met: ${UTILIZATION}% utilization"
          else
            echo "   âš ï¸ SLO at risk: ${UTILIZATION}% utilization"
          fi

      - name: Check Customer Loop SLO (contracts presented)
        run: |
          echo ""
          echo "ğŸ”— Customer Loop SLO Check:"
          echo "   Target: >50% of contracts presented to customers"

          CONTRACTS=${{ needs.autonomous-cycle.outputs.contracts }}
          PRESENTED=${{ needs.autonomous-cycle.outputs.presented }}

          if [ "$CONTRACTS" -gt 0 ]; then
            PRESENTATION_RATE=$(echo "scale=1; $PRESENTED * 100 / $CONTRACTS" | bc)
            echo "   Presentation rate: ${PRESENTATION_RATE}% ($PRESENTED/$CONTRACTS)"

            if (( $(echo "$PRESENTATION_RATE >= 50" | bc -l) )); then
              echo "   âœ… SLO met: Contracts being presented to customers"
            else
              echo "   âš ï¸ SLO missed: Low presentation rate"
              echo "   Action: Configure outreach channels (RESEND_API_KEY, etc.)"
            fi
          else
            echo "   â„¹ï¸ No contracts this cycle - skipping SLO check"
          fi

  # ============================================================================
  # ALERTING: Critical Failure Handling
  # ============================================================================
  alert-on-failure:
    name: Alert on Critical Failure
    runs-on: ubuntu-latest
    needs: [health-check, autonomous-cycle]
    if: failure()
    timeout-minutes: 2

    steps:
      - name: Capture Failure Context
        run: |
          echo "ğŸš¨ CRITICAL FAILURE DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Run Details:"
          echo "   Run ID: ${{ github.run_id }}"
          echo "   Run Number: ${{ github.run_number }}"
          echo "   Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""

          # Capture system state at failure
          echo "System State at Failure:"
          curl -s ${{ env.RUNTIME_URL }}/integration/health | jq '.'

          echo ""
          echo "Recent Errors (if any):"
          curl -s ${{ env.RUNTIME_URL }}/integration/stats | jq '.stats.errors // "No error data"'

      - name: Send Alert (Placeholder)
        run: |
          echo ""
          echo "ğŸ“¢ Alert channels (configure secrets):"
          echo "   - SLACK_WEBHOOK_URL"
          echo "   - DISCORD_WEBHOOK_URL"
          echo "   - PAGERDUTY_KEY"

          # Example Slack alert (uncomment when configured):
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ Autonomous cycle failed! Run: ${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # WEEKLY SUMMARY: Performance Report
  # ============================================================================
  weekly-summary:
    name: Weekly Performance Summary
    runs-on: ubuntu-latest
    # Run every Sunday at midnight UTC
    if: github.event.schedule == '0 0 * * 0'
    timeout-minutes: 5

    steps:
      - name: Generate Weekly Apex Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š WEEKLY APEX PERFORMANCE REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Week ending: $(date -u +%Y-%m-%d)"
          echo ""

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          echo "ğŸ’° Revenue Metrics:"
          echo "$STATS" | jq '{
            total_contracts: .stats.escrow.contracts_created,
            total_revenue_usd: .stats.escrow.total_value_usd,
            total_released_usd: .stats.escrow.total_released_usd,
            avg_contract_value: (.stats.escrow.total_value_usd / (.stats.escrow.contracts_created + 0.001) | floor)
          }'

          echo ""
          echo "ğŸš€ Apex Features Performance:"
          echo "   FA30 contracts delivered: TBD"
          echo "   Dual-track efficiency gain: TBD"
          echo "   Hot-start kits applied: TBD"
          echo "   Multi-lingual outreach: TBD"

          echo ""
          echo "ğŸ‘· Workforce Utilization:"
          echo "$STATS" | jq '{
            tasks_total: .stats.workforce.tasks_dispatched,
            tasks_completed: .stats.workforce.tasks_completed,
            success_rate: ((.stats.workforce.tasks_completed / (.stats.workforce.tasks_dispatched + 0.001)) * 100 | floor),
            fabric_vs_human: "\(.stats.workforce.fabric_tasks // 0) fabric / \(.stats.workforce.human_tasks // 0) human"
          }'

          echo ""
          echo "ğŸ† Wall of Wins (Real Revenue):"
          WINS=$(curl -s ${{ env.RUNTIME_URL }}/integration/wall-of-wins)
          echo "   Completed contracts: $(echo "$WINS" | jq -r '.count // 0')"
          echo "   Total revenue collected: \$$(echo "$WINS" | jq -r '.total_revenue_usd // 0')"

          echo ""
          echo "ğŸ”— Customer Loop Performance:"
          LOOP_STATUS=$(curl -s ${{ env.RUNTIME_URL }}/integration/customer-loop-status)
          echo "   Configured channels: $(echo "$LOOP_STATUS" | jq -r '.customer_loop.configured_channels | length // 0')"
          echo "   Can present contracts: $(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_present_contracts // false')"
          echo "   Can accept payments: $(echo "$LOOP_STATUS" | jq -r '.customer_loop.can_accept_payments // false')"

      - name: Calculate Week-over-Week Growth
        run: |
          echo ""
          echo "ğŸ“ˆ Growth Indicators:"
          echo "   (Compare with previous week stats from storage)"
          echo "   Revenue growth: TBD%"
          echo "   Contract growth: TBD%"
          echo "   Conversion improvement: TBD%"

  # ============================================================================
  # DAILY OPTIMIZATION: Learning & Tuning
  # ============================================================================
  daily-optimization:
    name: Daily Optimization Check
    runs-on: ubuntu-latest
    # Run daily at 6 AM UTC
    if: github.event.schedule == '0 6 * * *'
    timeout-minutes: 5

    steps:
      - name: Analyze Execution Patterns
        run: |
          echo "ğŸ§  Daily Optimization Analysis"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          STATS=$(curl -s ${{ env.RUNTIME_URL }}/integration/stats)

          echo ""
          echo "ğŸ“Š Pattern Analysis:"
          echo "   Analyzing yesterday's executions for optimization..."

          # Check for patterns that need attention
          TASK_SUCCESS=$(echo "$STATS" | jq -r '
            ((.stats.workforce.tasks_completed // 0) /
            ((.stats.workforce.tasks_dispatched // 1) + 0.001)) * 100 | floor
          ')

          echo "   Task success rate: ${TASK_SUCCESS}%"

          if [ "$TASK_SUCCESS" -lt 70 ]; then
            echo "   âš ï¸ Recommendation: Review failed tasks and adjust routing"
          fi

      - name: Check Selector Health
        run: |
          echo ""
          echo "ğŸ” Selector Health Check:"
          echo "   Checking for shadow selectors ready for cutover..."
          # Would query selector_healer for pending cutovers

      - name: Suggest Optimizations
        run: |
          echo ""
          echo "ğŸ’¡ Optimization Suggestions:"
          echo "   1. Review low-converting opportunity sources"
          echo "   2. Check FA30 SLA compliance trends"
          echo "   3. Analyze hot-start kit usage by pack"
          echo "   4. Review multi-lingual outreach effectiveness"
